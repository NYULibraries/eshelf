machine:
  post:
    - "echo Removing project .ruby-version, contents were: && cat $CIRCLE_PROJECT_REPONAME/.ruby-version"
    - "rm $CIRCLE_PROJECT_REPONAME/.ruby-version"
    - |
      if [[ -e ~/rvm_binaries/ruby-2.3.3.tar.bz2 ]]
      then
        rvm mount ~/rvm_binaries/ruby-2.3.3.tar.bz2
      else
        mkdir -p ~/rvm_binaries
        rvm install ruby-2.3.3
        cd ~/rvm_binaries && rvm prepare ruby-2.3.3
      fi
    - rvm --default use ruby-2.3.3

  environment:
    ESHELF_DB_USER: root

dependencies:
  post:
    - npm install -g istanbul

test:
  override:
    - RAILS_ENV=test bundle exec rspec -r rspec_junit_formatter --format progress --format RspecJunitFormatter -o $CIRCLE_TEST_REPORTS/rspec/junit.xml
    - mkdir -p $CIRCLE_TEST_REPORTS/cucumber
    - RAILS_ENV=test bundle exec cucumber --format pretty --format json --out $CIRCLE_TEST_REPORTS/cucumber/tests.cucumber
    - RAILS_ENV=test bundle exec rake test
  post:
    - bundle exec rake teaspoon
    - bundle exec rake coveralls:push
## Customize database setup
database:
  override:
    - mysql -e 'create database eshelf_test;'
    - bundle exec rake db:schema:load RAILS_ENV=test
    
deployment:
  production:
    branch: master
    # owner: NYULibraries
    commands:
      - curl -u $JENKINS_USERNAME:$JENKINS_API_KEY -X POST http://jenkins.library.nyu.edu/view/E-Shelf/job/E-Shelf%20Production%20Deploy/build/api
  qa:
    branch: qa
    # owner: NYULibraries
    commands:
      - curl -u $JENKINS_USERNAME:$JENKINS_API_KEY -X POST http://jenkins.library.nyu.edu/view/E-Shelf/job/E-Shelf%20QA%20Deploy/build/api
  development:
    branch: /.+/
    # owner: NYULibraries
    commands:
      - curl -u $JENKINS_USERNAME:$JENKINS_API_KEY -X POST http://jenkins.library.nyu.edu/view/E-Shelf/job/E-Shelf%20Development%20Deploy/build/api

